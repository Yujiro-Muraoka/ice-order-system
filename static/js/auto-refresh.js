/**
 * cafeMuji Ëá™ÂãïÊõ¥Êñ∞Ê©üËÉΩ
 * ÊåáÂÆö„Åó„ÅüDOMË¶ÅÁ¥†„ÅÆÊï∞ÂÄ§„ÅåÂ¢óÂä†„Åó„Åü„Çø„Ç§„Éü„É≥„Ç∞„ÄÅ„ÇÇ„Åó„Åè„ÅØ‰∏ÄÂÆöÈñìÈöî„ÅßÁîªÈù¢„ÇíÂÜçË™≠„ÅøËæº„Åø„Åô„Çã„Éò„É´„Éë„Éº„ÄÇ
 *
 * ÊÉ≥ÂÆö„É¶„Éº„Çπ„Ç±„Éº„Çπ:
 *   - „Ç≠„ÉÉ„ÉÅ„É≥/„Éá„Ç∑„É£„ÉÉ„ÉóÁîªÈù¢„ÅßÊú™ÂÆå‰∫Ü‰ª∂Êï∞„ÅåÂ¢ó„Åà„Åü„ÇâËá™ÂãïÁöÑ„Å´ÊúÄÊñ∞Áä∂ÊÖã„Å∏Êõ¥Êñ∞
 *   - ÂæÖ„Å°ÊôÇÈñìË°®Á§∫ÁîªÈù¢„ÅÆ„Çà„ÅÜ„Å´„ÄÅÂçòÁ¥î„Å´ n Áßí„Åî„Å®„É™„É≠„Éº„Éâ„Åó„Åü„ÅÑ„Ç±„Éº„Çπ
 */

class AutoRefresh {
    constructor(options = {}) {
        /**
         * @property {number} interval - Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆÈñìÈöî(ms)„ÄÇ„Éá„Éï„Ç©„É´„Éà„ÅØ 5 Áßí„ÄÇ
         */
        this.interval = options.interval || 5000; // 5ÁßíÈñìÈöî
        /**
         * @property {string} storageKey - ÂâçÂõûÂÄ§„Çí‰øùÂ≠ò„Åô„Çã localStorage „Ç≠„Éº„ÄÇÁîªÈù¢„Åî„Å®„Å´Â§â„Åà„Çã„Å®Á´∂Âêà„Åó„Å™„ÅÑ„ÄÇ
         */
        this.storageKey = options.storageKey || 'auto_refresh_value';
        /**
         * @property {string} valueSelector - Áõ£Ë¶ñÂØæË±°„Å®„Å™„ÇãË¶ÅÁ¥†„ÅÆ CSS „Çª„É¨„ÇØ„Çø„ÄÇ
         *                                    `data-auto-refresh-value` Â±ûÊÄß„Åã textContent „Åã„ÇâÂÄ§„ÇíÂèñÂæó„Åô„Çã„ÄÇ
         */
        this.valueSelector = options.valueSelector || '[data-auto-refresh-value]';
        /**
         * @property {Function} parseValue - Ë¶ÅÁ¥†„Åã„ÇâÂÄ§„ÇíÊäΩÂá∫„Åô„ÇãÈñ¢Êï∞„ÄÇÁîªÈù¢„Åî„Å®„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅåÈÅï„ÅÜÂ†¥Âêà„Å´Â∑Æ„ÅóÊõø„Åà„Çã„ÄÇ
         */
        this.parseValue = options.parseValue || ((raw) => {
            if (raw === null || raw === undefined) {
                return null;
            }
            const text = String(raw);
            const match = text.match(/-?\d+(?:\.\d+)?/);
            return match ? Number(match[0]) : null;
        });
        /**
         * @property {boolean} reloadOnDecrease - ÂÄ§„ÅåÊ∏õÂ∞ë„Åó„ÅüÈöõ„ÇÇ„É™„É≠„Éº„Éâ„Åô„Çã„Åã„Å©„ÅÜ„Åã„ÄÇÊó¢ÂÆö„Åß„ÅØ true„ÄÇ
         *                                       ÂæÖ„Å°‰∫∫Êï∞„Å™„Å©Â¢óÊ∏õ„ÇíÂÖ®„Å¶ÂèçÊò†„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ true „ÅÆ„Åæ„Åæ„ÄÇ
         */
        this.reloadOnDecrease = options.reloadOnDecrease !== undefined ? options.reloadOnDecrease : true;
        /**
         * @property {boolean} forceReload - ÂÄ§„ÅÆÂ∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ„Çí„Åõ„Åö„ÄÅÂ∏∏„Å´ interval „Åî„Å®„Å´„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åô„Çã„ÄÇ
         *                                   ÂæÖ„Å°ÊôÇÈñìË°®Á§∫„ÅÆ„Çà„ÅÜ„Å´ÂçòÁ¥î„Å´Âë®Êúü„É™„É≠„Éº„Éâ„Åó„Åü„ÅÑÁîªÈù¢„Åß‰ΩøÁî®„ÄÇ
         */
        this.forceReload = options.forceReload || false;
        /**
         * @property {boolean} createButton - Âè≥‰∏ä„ÅÆÊâãÂãïÊõ¥Êñ∞„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã„Åã„Å©„ÅÜ„Åã„ÄÇ
         *                                   „Çπ„ÉÜ„Éº„Çø„Çπ„É¢„Éã„ÇøÁîªÈù¢„Åß„ÅØ true„ÄÅÁúãÊùøÁî®ÁîªÈù¢„Åß„ÅØ false „Å´„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„ÄÇ
         */
        this.createButton = options.createButton !== undefined ? options.createButton : true;
        /**
         * @property {string} scrollStorageKey - „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ‰øùÂ≠ò„Å´Áî®„ÅÑ„Çã localStorage „Ç≠„Éº„ÄÇ
         *                                      Ë§áÊï∞ÁîªÈù¢„ÅßÂêåÊôÇ‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Â§âÊõ¥ÂèØËÉΩ„ÄÇ
         */
        this.scrollStorageKey = options.scrollStorageKey || 'scroll_position';
        /**
         * @property {?number} refreshTimer - setInterval „ÅÆË≠òÂà•Â≠ê„ÄÇÂÅúÊ≠¢ÊôÇ„Å´„ÇØ„É™„Ç¢„Åô„Çã„ÄÇ
         */
        this.refreshTimer = null;
        /**
         * @property {boolean} isActive - „Éö„Éº„Ç∏„Åå„Éï„Ç©„Ç¢„Ç∞„É©„Ç¶„É≥„Éâ„ÅÆÂ†¥Âêà„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØ„ÇíË°å„ÅÜ„Åü„ÇÅ„ÅÆ„Éï„É©„Ç∞„ÄÇ
         */
        this.isActive = true;

        this.prepareInitialValue();

        if (this.createButton) {
            this.createRefreshButton();
        }

        if (this.forceReload) {
            this.refreshTimer = setInterval(() => {
                this.refreshPage();
            }, this.interval);
            return;
        }

        this.start();
        this.setupVisibilityChange();
    }

    prepareInitialValue() {
        // ÂàùÂõû„É≠„Éº„ÉâÊôÇ„Å´Áõ£Ë¶ñÂØæË±°„ÅÆË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„Çå„Å∞„ÄÅ„Åù„ÅÆÂÄ§„Çí localStorage „Å´‰øùÂ≠ò„Åó„Å¶„Åä„Åè„ÄÇ
        // ‰ªñ„Éö„Éº„Ç∏„Å® storageKey „ÅåË°ùÁ™Å„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„Åß„ÇÇÊÑèÂõ≥„Åõ„Åö„É™„É≠„Éº„Éâ„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„ÄÅÊó¢„Å´ÂÄ§„Åå„ÅÇ„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó„ÄÇ
        const element = document.querySelector(this.valueSelector);
        if (!element) {
            return;
        }
        const stored = localStorage.getItem(this.storageKey);
        if (stored !== null) {
            return;
        }
        const raw = element.getAttribute('data-auto-refresh-value') ?? element.textContent;
        const value = this.parseValue(raw, element);
        if (value !== null && !Number.isNaN(value)) {
            localStorage.setItem(this.storageKey, value.toString());
        }
    }

    /**
     * ÊâãÂãïÊõ¥Êñ∞„Éú„Çø„É≥„Çí‰ΩúÊàê
     */
    createRefreshButton() {
        // ÁîªÈù¢Âè≥‰∏ä„Å´ÊâãÂãïÊõ¥Êñ∞„Éú„Çø„É≥„ÇíÈÖçÁΩÆ„ÄÇÂøÖË¶Å„Å´Âøú„Åò„Å¶ createButton=false „ÅßÈùûË°®Á§∫„Å´„Åß„Åç„Çã„ÄÇ
        const button = document.createElement('button');
        button.textContent = 'üîÑ ÊâãÂãïÊõ¥Êñ∞';
        button.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        `;

        button.addEventListener('click', () => {
            this.manualRefresh();
        });

        document.body.appendChild(button);
    }

    /**
     * Ëá™ÂãïÊõ¥Êñ∞„ÇíÈñãÂßã
     */
    start() {
        if (this.refreshTimer) {
            clearInterval(this.refreshTimer);
        }

        this.refreshTimer = setInterval(() => {
            if (this.isActive) {
                this.checkForUpdates();
            }
        }, this.interval);
    }

    /**
     * Ëá™ÂãïÊõ¥Êñ∞„ÇíÂÅúÊ≠¢
     */
    stop() {
        if (this.refreshTimer) {
            clearInterval(this.refreshTimer);
            this.refreshTimer = null;
        }
    }

    getStoredValue() {
        // localStorage „Åã„ÇâÂâçÂõûÂÄ§„ÇíÂèñÂæó„ÄÇÊï∞ÂÄ§ÊñáÂ≠óÂàó„Åß‰øùÂ≠ò„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ Number Âåñ„Åó„Å¶ËøîÂç¥„ÄÇ
        const stored = localStorage.getItem(this.storageKey);
        if (stored === null) {
            return null;
        }
        const num = Number(stored);
        return Number.isNaN(num) ? stored : num;
    }

    setStoredValue(value) {
        // null / undefined / NaN „ÅØÁÑ°Ë¶ñ„Åó„ÄÅÊ≠£Ë¶è„ÅÆÂÄ§„ÅÆ„Åø‰øùÂ≠ò„ÄÇ
        if (value === null || value === undefined || Number.isNaN(value)) {
            return;
        }
        localStorage.setItem(this.storageKey, value.toString());
    }

    /**
     * Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
     */
    async checkForUpdates() {
        try {
            const response = await fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                return;
            }

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const element = doc.querySelector(this.valueSelector);
            if (!element) {
                // ÂØæË±°Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éö„Éº„Ç∏ÊßãÈÄ†„ÅåÂ§â„Çè„Å£„Åü„Å®Âà§Êñ≠„Åó„É™„É≠„Éº„Éâ„ÄÇ
                this.refreshPage();
                return;
            }

            const raw = element.getAttribute('data-auto-refresh-value') ?? element.textContent;
            const currentValue = this.parseValue(raw, element);

            if (currentValue === null || Number.isNaN(currentValue)) {
                // ÂÄ§„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÇÇ„É™„É≠„Éº„Éâ„ÄÇÁîªÈù¢Áπ∞„ÇäËøî„ÅóË™≠„ÅøËæº„Åø„ÅßÂÆâÂÆöÂåñ„Åï„Åõ„Çã„ÄÇ
                this.refreshPage();
                return;
            }

            const previousValue = this.getStoredValue();

            if (previousValue === null) {
                // ÂàùÂõûÂÆüË°å„Å™„Å©„ÅßÂâçÂõûÂÄ§„ÅåÁÑ°„ÅÑÂ†¥Âêà„ÅØ‰øùÂ≠ò„Å†„ÅëË°å„ÅÑÁµÇ‰∫Ü„ÄÇ
                this.setStoredValue(currentValue);
                return;
            }

            if (currentValue > previousValue || (this.reloadOnDecrease && currentValue !== previousValue)) {
                // ÂÄ§„ÅåÂ¢óÂä†„ÄÅ„Åæ„Åü„ÅØÊ∏õÂ∞ë„Åß„ÇÇÁõ£Ë¶ñÂØæË±°„Å™„ÇâÂç≥„É™„É≠„Éº„Éâ„ÄÇ
                this.setStoredValue(currentValue);
                this.refreshPage();
            } else if (currentValue !== previousValue) {
                // „É™„É≠„Éº„ÉâÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åï„Å™„ÅÑÂ∑ÆÂàÜ„ÅÆÂ†¥Âêà„Åß„ÇÇÂÄ§„ÅØÊõ¥Êñ∞„Åó„Å¶„Åä„Åè„ÄÇ
                this.setStoredValue(currentValue);
            }
        } catch (error) {
            console.error('Ëá™ÂãïÊõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', error);
            this.refreshPage();
        }
    }

    /**
     * „Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞
     */
    refreshPage() {
        // „É™„É≠„Éº„ÉâÂâç„Å´ÁèæÂú®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰øùÂ≠ò„Åó„ÄÅÂæ©Â∏∞ÊôÇ„Å´Êàª„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÄÇ
        const scrollPosition = window.pageYOffset;
        localStorage.setItem(this.scrollStorageKey, scrollPosition.toString());

        window.location.reload();
    }

    /**
     * ÊâãÂãïÊõ¥Êñ∞
     */
    manualRefresh() {
        this.refreshPage();
    }

    /**
     * „Éö„Éº„Ç∏„ÅÆÂèØË¶ñÊÄßÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
     */
    setupVisibilityChange() {
        // „Çø„Éñ„ÅåÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Èñì„ÅØ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„É™„ÇØ„Ç®„Çπ„Éà„ÇíÊäëÂà∂„Åó„ÄÅÊàª„Å£„Åü„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂç≥„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„ÄÇ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.isActive = false;
            } else {
                this.isActive = true;
                setTimeout(() => {
                    this.checkForUpdates();
                }, 1000);
            }
        });
    }

    /**
     * „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
     */
    static restoreScrollPosition(key = 'scroll_position') {
        // ‰∏äË®ò refreshPage „Åß‰øùÂ≠ò„Åó„Åü„Çπ„ÇØ„É≠„Éº„É´ÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ„Åó„ÄÅ„Åù„ÅÆÂæå„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÈô§Âéª„Åô„Çã„ÄÇ
        const scrollPosition = localStorage.getItem(key);
        if (scrollPosition) {
            window.scrollTo(0, parseInt(scrollPosition, 10));
            localStorage.removeItem(key);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    AutoRefresh.restoreScrollPosition();
});

window.AutoRefresh = AutoRefresh;