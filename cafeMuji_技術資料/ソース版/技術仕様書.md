# cafeMuji 注文管理システム 技術仕様書

## 1. 技術スタック

### 1.1 バックエンド
- **言語**: Python 3.13.7
- **フレームワーク**: Django 5.2.6
- **API**: Django REST Framework 3.14.0
- **Webサーバー**: gunicorn 23.0.0
- **WSGI**: Django標準WSGI

### 1.2 フロントエンド
- **テンプレートエンジン**: Django Templates
- **CSS**: カスタムCSS（レスポンシブ対応）
- **JavaScript**: 最小限（Djangoの機能を活用）
- **API連携**: REST API対応

### 1.3 データベース
- **開発環境**: SQLite 3.x（パフォーマンスインデックス付）
- **本番環境**: PostgreSQL推奨（SQLite対応）
- **ORM**: Django ORM
- **キャッシュ**: Django LocMem Cache

### 1.4 新機能・強化項目（v2.0）
- **REST API**: 完全なCRUD操作とヘルスチェック
- **テストスイート**: 包括的な単体・統合テスト
- **エラーハンドリング**: 包括的エラー処理とログ機能
- **パフォーマンス最適化**: データベースインデックス、キャッシュ
- **監視機能**: システム統計とヘルスチェック

### 1.5 インフラ・デプロイ
- **ホスティング**: Render.com
- **静的ファイル**: Render CDN
- **バージョン管理**: Git
- **CORS対応**: モバイル・外部API連携

## 2. プロジェクト構造

### 2.1 ディレクトリ構成
```
cafeMuji/
├── config/                 # プロジェクト設定
│   ├── __init__.py
│   ├── settings.py        # Django設定
│   ├── urls.py           # メインURL設定
│   ├── asgi.py           # ASGI設定
│   └── wsgi.py           # WSGI設定
├── food/                  # フード注文管理アプリ
│   ├── models.py         # データベースモデル
│   ├── views.py          # ビュー（処理ロジック）
│   ├── urls.py           # URLルーティング
│   ├── admin.py          # 管理画面設定
│   └── templates/        # テンプレート
├── ice/                   # アイスクリーム注文管理アプリ
├── shavedice/             # かき氷注文管理アプリ
├── mobile/                # モバイル対応
├── common/                # 共通機能
├── static/                # 静的ファイル
├── templates/             # 共通テンプレート
├── manage.py              # Django管理コマンド
├── requirements.txt       # 依存関係
└── Procfile              # Render用設定
```

### 2.2 アプリケーション設計
各アプリは独立した機能を持ち、DjangoのMVT（Model-View-Template）パターンに従って設計されています。

## 3. データベース設計

### 3.1 フード注文テーブル（FoodOrder）
```python
class FoodOrder(models.Model):
    # 注文内容
    menu = models.CharField(max_length=20)           # メニュー名
    quantity = models.PositiveIntegerField(default=1) # 数量
    eat_in = models.BooleanField(default=True)       # 店内/テイクアウト
    
    # クリップ情報
    clip_color = models.CharField(max_length=10)     # クリップ色
    clip_number = models.IntegerField()              # クリップ番号
    
    # 注文管理
    group_id = models.CharField(max_length=50)       # グループID
    status = models.CharField(max_length=10, default='ok') # 注文状態
    is_completed = models.BooleanField(default=False) # 完了フラグ
    
    # 時刻管理
    timestamp = models.DateTimeField(auto_now_add=True) # 受注時刻
    completed_at = models.DateTimeField(null=True, blank=True) # 完了時刻
    
    # その他
    note = models.TextField(blank=True, null=True)   # 備考
```

### 3.2 アイスクリーム注文テーブル（Order）
```python
class Order(models.Model):
    group_id = models.CharField(max_length=20)       # グループID
    size = models.CharField(max_length=2)            # サイズ（S/W）
    container = models.CharField(max_length=10)      # 容器（cup/cone）
    flavor1 = models.CharField(max_length=50)       # フレーバー1
    flavor2 = models.CharField(max_length=50, blank=True, null=True) # フレーバー2
    is_completed = models.BooleanField(default=False) # 完了フラグ
    timestamp = models.DateTimeField(auto_now_add=True) # 受注時刻
    status = models.CharField(max_length=10, default='ok') # 注文状態
    clip_color = models.CharField(max_length=10)     # クリップ色
    clip_number = models.IntegerField()              # クリップ番号
    completed_at = models.DateTimeField(null=True, blank=True) # 完了時刻
    is_auto_stopped = models.BooleanField(default=False) # 自動STOP
    note = models.TextField(blank=True, null=True)   # 備考
    is_pudding = models.BooleanField(default=False)  # アフォガードプリン
```

### 3.3 かき氷注文テーブル（ShavedIceOrder）
```python
class ShavedIceOrder(models.Model):
    flavor = models.CharField(max_length=50)         # フレーバー
    group_id = models.CharField(max_length=50, default='') # グループID
    is_completed = models.BooleanField(default=False) # 完了フラグ
    clip_color = models.CharField(max_length=10, default='white') # クリップ色
    clip_number = models.IntegerField(default=0)     # クリップ番号
    timestamp = models.DateTimeField(auto_now_add=True) # 受注時刻
    completed_at = models.DateTimeField(null=True, blank=True) # 完了時刻
    status = models.CharField(max_length=10, default='ok') # 注文状態
    is_auto_stopped = models.BooleanField(default=False) # 自動STOP
    note = models.TextField(blank=True, null=True)   # 備考
```

## 4. ビュー設計

### 4.1 フード注文管理
- **food_register**: 注文登録画面
- **add_temp_food**: 仮注文追加
- **remove_temp_food**: 仮注文削除
- **food_kitchen**: キッチン画面
- **complete_food**: 注文完了処理
- **confirm_food**: 本注文確定

### 4.2 アイスクリーム注文管理
- **ice**: 注文画面
- **register**: 注文登録
- **detail**: 注文詳細
- **deshap**: 注文削除

### 4.3 かき氷注文管理
- **shavedice**: 注文画面
- **shavedice_register**: 注文登録
- **shavedice_kitchen**: キッチン画面
- **wait_time**: 待ち時間表示

## 5. URL設計

### 5.1 メインURL設定
```python
# config/urls.py
urlpatterns = [
    path('admin/', admin.site.urls),
    path('food/', include('food.urls')),
    path('ice/', include('ice.urls')),
    path('shavedice/', include('shavedice.urls')),
    path('mobile/', include('mobile.urls')),
]
```

### 5.2 各アプリのURL
各アプリケーションで独立したURLルーティングを実装し、名前空間を明確に分離しています。

## 6. セッション管理

### 6.1 仮注文の管理
```python
# セッションから仮注文リストを取得
temp_food = request.session.get('temp_food', [])

# 仮注文をセッションに保存
request.session['temp_food'] = temp_food
```

### 6.2 セッション設定
```python
# settings.py
SESSION_ENGINE = 'django.contrib.sessions.backends.db'
SESSION_COOKIE_AGE = 86400  # 24時間
```

## 7. セキュリティ実装

### 7.1 CSRF保護
```python
from django.views.decorators.csrf import csrf_exempt

@csrf_exempt
def add_temp_food(request):
    # 仮注文追加処理
```

### 7.2 入力値検証
```python
# 入力値の妥当性チェック
if not menu or eat_in_str not in ['0', '1']:
    return redirect('food_register')
```

## 8. REST API仕様（v2.0新機能）

### 8.1 エンドポイント一覧
```
GET    /api/food-orders/           # フード注文一覧
POST   /api/food-orders/           # 新規フード注文
GET    /api/food-orders/{id}/      # フード注文詳細
PUT    /api/food-orders/{id}/      # フード注文更新
DELETE /api/food-orders/{id}/      # フード注文削除
POST   /api/food-orders/{id}/complete/  # フード注文完了

GET    /api/ice-orders/            # アイス注文一覧
POST   /api/ice-orders/            # 新規アイス注文
POST   /api/ice-orders/{id}/complete/   # アイス注文完了
POST   /api/ice-orders/{id}/update_status/  # ステータス更新

GET    /api/shavedice-orders/      # かき氷注文一覧
POST   /api/shavedice-orders/      # 新規かき氷注文
POST   /api/shavedice-orders/{id}/complete/  # かき氷注文完了

GET    /api/health/                # システムヘルスチェック
GET    /api/food-orders/statistics/  # フード注文統計
```

### 8.2 レスポンス例
```json
{
  "id": 1,
  "menu": "からあげ丼",
  "quantity": 2,
  "eat_in": true,
  "clip_color": "yellow",
  "clip_number": 1,
  "group_id": "20250930_134530",
  "status": "ok",
  "is_completed": false,
  "timestamp": "2025-09-30T13:45:30.123456+09:00",
  "completed_at": null,
  "note": "備考"
}
```

## 9. パフォーマンス最適化（v2.0強化）

### 9.1 データベース最適化
```python
# 追加されたインデックス
class FoodOrder(models.Model):
    class Meta:
        indexes = [
            models.Index(fields=['status', 'is_completed']),
            models.Index(fields=['clip_color', 'clip_number']),
            models.Index(fields=['timestamp']),
            models.Index(fields=['group_id']),
            models.Index(fields=['menu', 'is_completed']),
        ]
```

### 9.2 キャッシュ設定
```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'cafeMuji-cache',
        'TIMEOUT': 300,  # 5分間キャッシュ
    }
}
```

### 9.3 クエリ最適化
- select_related()とprefetch_related()の活用
- 不要なフィールドの除外
- バッチ処理による効率化

## 10. エラーハンドリング（v2.0強化）

### 10.1 包括的エラー処理
```python
@handle_errors
def my_view(request):
    # ビュー処理
    pass
```

### 10.2 ログ設定
```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/django.log',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'INFO',
        },
        'cafeMuji': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG',
        },
    },
}
```

## 11. テスト戦略（v2.0新実装）

### 11.1 テストカバレッジ
- **モデルテスト**: 27個のテストケース
- **ビューテスト**: 包括的なHTTPリクエスト/レスポンステスト
- **APIテスト**: REST APIエンドポイントテスト
- **セッションテスト**: 仮注文機能テスト

### 11.2 実装テスト例
```python
class FoodOrderModelTest(TestCase):
    def test_food_order_creation(self):
        order = FoodOrder.objects.create(
            menu='からあげ丼',
            quantity=2,
            clip_color='yellow',
            clip_number=1,
            group_id='test_001'
        )
        self.assertEqual(order.menu, 'からあげ丼')
        self.assertFalse(order.is_completed)
```

### 11.3 テスト実行
```bash
# 全テスト実行
python manage.py test

# 特定アプリのテスト
python manage.py test food.tests

# カバレッジ測定
coverage run manage.py test
coverage report
```

### 10.2 統合テスト
- エンドツーエンドのテスト
- データベース操作のテスト

---

**作成日**: 2025年8月
**作成者**: 村岡 優次郎
**バージョン**: 1.0
