<h1 id="cafemuji-注文管理システム-データベース設計書">cafeMuji
注文管理システム データベース設計書</h1>
<h2 id="データベース概要">1. データベース概要</h2>
<h3 id="データベースエンジン">1.1 データベースエンジン</h3>
<ul>
<li><strong>開発環境</strong>: SQLite 3.x</li>
<li><strong>本番環境</strong>: SQLite（PostgreSQL推奨）</li>
<li><strong>ORM</strong>: Django ORM</li>
</ul>
<h3 id="設計方針">1.2 設計方針</h3>
<ul>
<li><strong>正規化</strong>: 第3正規形を基本とする</li>
<li><strong>拡張性</strong>: 将来の機能追加に対応できる柔軟な設計</li>
<li><strong>パフォーマンス</strong>: 適切なインデックス設計</li>
<li><strong>整合性</strong>: 外部キー制約によるデータ整合性の確保</li>
</ul>
<h2 id="er図">2. ER図</h2>
<h3 id="エンティティ関係図">2.1 エンティティ関係図</h3>
<pre><code>[FoodOrder] ----&lt; [注文グループ] &gt;---- [Order]
     |                                    |
     |                                    |
[フード注文]                          [アイスクリーム注文]
     |                                    |
     |                                    |
[クリップ情報]                        [フレーバー情報]
     |                                    |
     |                                    |
[注文状態]                            [注文状態]

[ShavedIceOrder] ----&lt; [注文グループ] &gt;---- [共通属性]
     |                                    |
     |                                    |
[かき氷注文]                          [時刻管理]
     |                                    |
     |                                    |
[フレーバー]                          [完了状態]</code></pre>
<h2 id="テーブル設計詳細">3. テーブル設計詳細</h2>
<h3 id="フード注文テーブルfoodorder">3.1
フード注文テーブル（FoodOrder）</h3>
<h4 id="テーブル概要">テーブル概要</h4>
<p>フード注文（からあげ丼、ルーロー飯）の全情報を管理するテーブル</p>
<h4 id="フィールド定義">フィールド定義</h4>
<table>
<thead>
<tr>
<th>フィールド名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>AutoField</td>
<td>Primary Key</td>
<td>自動採番ID</td>
</tr>
<tr>
<td>menu</td>
<td>CharField(20)</td>
<td>Not Null</td>
<td>メニュー名</td>
</tr>
<tr>
<td>quantity</td>
<td>PositiveIntegerField</td>
<td>Default: 1</td>
<td>注文数量</td>
</tr>
<tr>
<td>eat_in</td>
<td>BooleanField</td>
<td>Default: True</td>
<td>店内/テイクアウト</td>
</tr>
<tr>
<td>clip_color</td>
<td>CharField(10)</td>
<td>Not Null</td>
<td>クリップ色</td>
</tr>
<tr>
<td>clip_number</td>
<td>IntegerField</td>
<td>Not Null</td>
<td>クリップ番号</td>
</tr>
<tr>
<td>group_id</td>
<td>CharField(50)</td>
<td>Not Null</td>
<td>グループID</td>
</tr>
<tr>
<td>status</td>
<td>CharField(10)</td>
<td>Default: ‘ok’</td>
<td>注文状態</td>
</tr>
<tr>
<td>is_completed</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>完了フラグ</td>
</tr>
<tr>
<td>timestamp</td>
<td>DateTimeField</td>
<td>Auto Now Add</td>
<td>受注時刻</td>
</tr>
<tr>
<td>completed_at</td>
<td>DateTimeField</td>
<td>Nullable</td>
<td>完了時刻</td>
</tr>
<tr>
<td>note</td>
<td>TextField</td>
<td>Nullable</td>
<td>備考</td>
</tr>
</tbody>
</table>
<h4 id="インデックス設計">インデックス設計</h4>
<div class="sourceCode" id="cb2"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主要検索用インデックス</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_food_order_group_id <span class="kw">ON</span> food_foodorder(<span class="fu">group_id</span>);</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_food_order_status <span class="kw">ON</span> food_foodorder(status);</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_food_order_completed <span class="kw">ON</span> food_foodorder(is_completed);</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_food_order_timestamp <span class="kw">ON</span> food_foodorder(<span class="dt">timestamp</span>);</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- 複合インデックス</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_food_order_clip <span class="kw">ON</span> food_foodorder(clip_color, clip_number);</span></code></pre></div>
<h4 id="制約">制約</h4>
<ul>
<li><code>quantity</code> &gt; 0</li>
<li><code>clip_number</code> &gt; 0</li>
<li><code>status</code> IN (‘ok’, ‘stop’)</li>
</ul>
<h3 id="アイスクリーム注文テーブルorder">3.2
アイスクリーム注文テーブル（Order）</h3>
<h4 id="テーブル概要-1">テーブル概要</h4>
<p>アイスクリーム注文の全情報を管理するテーブル</p>
<h4 id="フィールド定義-1">フィールド定義</h4>
<table>
<thead>
<tr>
<th>フィールド名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>AutoField</td>
<td>Primary Key</td>
<td>自動採番ID</td>
</tr>
<tr>
<td>group_id</td>
<td>CharField(20)</td>
<td>Not Null</td>
<td>グループID</td>
</tr>
<tr>
<td>size</td>
<td>CharField(2)</td>
<td>Choices</td>
<td>サイズ（S/W）</td>
</tr>
<tr>
<td>container</td>
<td>CharField(10)</td>
<td>Choices</td>
<td>容器（cup/cone）</td>
</tr>
<tr>
<td>flavor1</td>
<td>CharField(50)</td>
<td>Choices</td>
<td>フレーバー1</td>
</tr>
<tr>
<td>flavor2</td>
<td>CharField(50)</td>
<td>Nullable</td>
<td>フレーバー2</td>
</tr>
<tr>
<td>is_completed</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>完了フラグ</td>
</tr>
<tr>
<td>timestamp</td>
<td>DateTimeField</td>
<td>Auto Now Add</td>
<td>受注時刻</td>
</tr>
<tr>
<td>status</td>
<td>CharField(10)</td>
<td>Default: ‘ok’</td>
<td>注文状態</td>
</tr>
<tr>
<td>clip_color</td>
<td>CharField(10)</td>
<td>Choices</td>
<td>クリップ色</td>
</tr>
<tr>
<td>clip_number</td>
<td>IntegerField</td>
<td>Not Null</td>
<td>クリップ番号</td>
</tr>
<tr>
<td>completed_at</td>
<td>DateTimeField</td>
<td>Nullable</td>
<td>完了時刻</td>
</tr>
<tr>
<td>is_auto_stopped</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>自動STOP</td>
</tr>
<tr>
<td>note</td>
<td>TextField</td>
<td>Nullable</td>
<td>備考</td>
</tr>
<tr>
<td>is_pudding</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>アフォガードプリン</td>
</tr>
</tbody>
</table>
<h4 id="選択肢定義">選択肢定義</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># サイズ選択肢</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>SIZE_CHOICES <span class="op">=</span> [</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;S&#39;</span>, <span class="st">&#39;シングル&#39;</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;W&#39;</span>, <span class="st">&#39;ダブル&#39;</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 容器選択肢</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>CONTAINER_CHOICES <span class="op">=</span> [</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;cup&#39;</span>, <span class="st">&#39;カップ&#39;</span>),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;cone&#39;</span>, <span class="st">&#39;コーン&#39;</span>),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># フレーバー選択肢</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>FLAVOR_CHOICES <span class="op">=</span> [</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;jersey&#39;</span>, <span class="st">&#39;ジャージー牛乳&#39;</span>),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;ocha&#39;</span>, <span class="st">&#39;お茶&#39;</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;mango&#39;</span>, <span class="st">&#39;マンゴー&#39;</span>),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;mint&#39;</span>, <span class="st">&#39;チョコミント&#39;</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;caramel&#39;</span>, <span class="st">&#39;キャラメル&#39;</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;strawberry&#39;</span>, <span class="st">&#39;いちご&#39;</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;tachibana&#39;</span>, <span class="st">&#39;たちばな&#39;</span>),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;idashio&#39;</span>, <span class="st">&#39;井田塩&#39;</span>),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;cassis&#39;</span>, <span class="st">&#39;カシス&#39;</span>),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;chocolate&#39;</span>, <span class="st">&#39;ショコラ&#39;</span>),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;coffee&#39;</span>, <span class="st">&#39;コーヒー&#39;</span>),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;lemon&#39;</span>, <span class="st">&#39;レモン&#39;</span>),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 注文状態選択肢</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>ORDER_STATUS_CHOICES <span class="op">=</span> [</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;ok&#39;</span>, <span class="st">&#39;アイス作成OK&#39;</span>),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;stop&#39;</span>, <span class="st">&#39;アイス作成STOP&#39;</span>),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;hold&#39;</span>, <span class="st">&#39;保留（非表示待ち）&#39;</span>),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># クリップ色選択肢</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>CLIP_COLOR_CHOICES <span class="op">=</span> [</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;yellow&#39;</span>, <span class="st">&#39;黄色&#39;</span>),</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;white&#39;</span>, <span class="st">&#39;白色&#39;</span>),</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<h4 id="インデックス設計-1">インデックス設計</h4>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主要検索用インデックス</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_group_id <span class="kw">ON</span> ice_order(<span class="fu">group_id</span>);</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_status <span class="kw">ON</span> ice_order(status);</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_completed <span class="kw">ON</span> ice_order(is_completed);</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_timestamp <span class="kw">ON</span> ice_order(<span class="dt">timestamp</span>);</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- 複合インデックス</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_clip <span class="kw">ON</span> ice_order(clip_color, clip_number);</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_ice_order_flavor <span class="kw">ON</span> ice_order(flavor1, flavor2);</span></code></pre></div>
<h3 id="かき氷注文テーブルshavediceorder">3.3
かき氷注文テーブル（ShavedIceOrder）</h3>
<h4 id="テーブル概要-2">テーブル概要</h4>
<p>かき氷注文の全情報を管理するテーブル</p>
<h4 id="フィールド定義-2">フィールド定義</h4>
<table>
<thead>
<tr>
<th>フィールド名</th>
<th>データ型</th>
<th>制約</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>AutoField</td>
<td>Primary Key</td>
<td>自動採番ID</td>
</tr>
<tr>
<td>flavor</td>
<td>CharField(50)</td>
<td>Choices</td>
<td>フレーバー</td>
</tr>
<tr>
<td>group_id</td>
<td>CharField(50)</td>
<td>Default: ’’</td>
<td>グループID</td>
</tr>
<tr>
<td>is_completed</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>完了フラグ</td>
</tr>
<tr>
<td>clip_color</td>
<td>CharField(10)</td>
<td>Default: ‘white’</td>
<td>クリップ色</td>
</tr>
<tr>
<td>clip_number</td>
<td>IntegerField</td>
<td>Default: 0</td>
<td>クリップ番号</td>
</tr>
<tr>
<td>timestamp</td>
<td>DateTimeField</td>
<td>Auto Now Add</td>
<td>受注時刻</td>
</tr>
<tr>
<td>completed_at</td>
<td>DateTimeField</td>
<td>Nullable</td>
<td>完了時刻</td>
</tr>
<tr>
<td>status</td>
<td>CharField(10)</td>
<td>Default: ‘ok’</td>
<td>注文状態</td>
</tr>
<tr>
<td>is_auto_stopped</td>
<td>BooleanField</td>
<td>Default: False</td>
<td>自動STOP</td>
</tr>
<tr>
<td>note</td>
<td>TextField</td>
<td>Nullable</td>
<td>備考</td>
</tr>
</tbody>
</table>
<h4 id="選択肢定義-1">選択肢定義</h4>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># フレーバー選択肢</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>FLAVOR_CHOICES <span class="op">=</span> [</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;抹茶&#39;</span>, <span class="st">&#39;抹茶&#39;</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;いちご&#39;</span>, <span class="st">&#39;いちご&#39;</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;ゆず&#39;</span>, <span class="st">&#39;ゆず&#39;</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 注文状態選択肢</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>ORDER_STATUS_CHOICES <span class="op">=</span> [</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;ok&#39;</span>, <span class="st">&#39;アイス作成OK&#39;</span>),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;stop&#39;</span>, <span class="st">&#39;アイス作成STOP&#39;</span>),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;hold&#39;</span>, <span class="st">&#39;保留（非表示待ち）&#39;</span>),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># クリップ色選択肢</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>CLIP_COLOR_CHOICES <span class="op">=</span> [</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;yellow&#39;</span>, <span class="st">&#39;黄色&#39;</span>),</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&#39;white&#39;</span>, <span class="st">&#39;白色&#39;</span>),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<h2 id="データ整合性">4. データ整合性</h2>
<h3 id="外部キー制約">4.1 外部キー制約</h3>
<p>現在の設計では、各テーブルは独立しており、外部キー制約は設定されていません。これは以下の理由によります：</p>
<ul>
<li><strong>柔軟性</strong>: 各注文タイプを独立して管理</li>
<li><strong>拡張性</strong>: 将来の機能追加に対応</li>
<li><strong>パフォーマンス</strong>: 結合クエリの回避</li>
</ul>
<h3 id="ビジネスルール">4.2 ビジネスルール</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 注文状態の管理</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_order_status(order, new_status):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> new_status <span class="op">==</span> <span class="st">&#39;completed&#39;</span>:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        order.is_completed <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        order.completed_at <span class="op">=</span> timezone.now()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    order.status <span class="op">=</span> new_status</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    order.save()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># クリップ番号の重複チェック</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_clip_availability(color, number):</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    existing_orders <span class="op">=</span> FoodOrder.objects.<span class="bu">filter</span>(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        clip_color<span class="op">=</span>color,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        clip_number<span class="op">=</span>number,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        is_completed<span class="op">=</span><span class="va">False</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> existing_orders.count() <span class="op">==</span> <span class="dv">0</span></span></code></pre></div>
<h2 id="データ移行">5. データ移行</h2>
<h3 id="マイグレーションファイル">5.1 マイグレーションファイル</h3>
<p>各アプリケーションで独立したマイグレーションファイルを管理：</p>
<ul>
<li><code>food/migrations/</code>: フード注文関連のマイグレーション</li>
<li><code>ice/migrations/</code>:
アイスクリーム注文関連のマイグレーション</li>
<li><code>shavedice/migrations/</code>:
かき氷注文関連のマイグレーション</li>
</ul>
<h3 id="マイグレーション履歴">5.2 マイグレーション履歴</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># マイグレーションの確認</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py showmigrations</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># マイグレーションの実行</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py migrate</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># マイグレーションファイルの作成</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py makemigrations</span></code></pre></div>
<h2 id="バックアップ復旧">6. バックアップ・復旧</h2>
<h3 id="バックアップ戦略">6.1 バックアップ戦略</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># データベースのバックアップ</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py dumpdata <span class="op">&gt;</span> backup.json</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 特定アプリのバックアップ</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py dumpdata food <span class="op">&gt;</span> food_backup.json</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py dumpdata ice <span class="op">&gt;</span> ice_backup.json</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py dumpdata shavedice <span class="op">&gt;</span> shavedice_backup.json</span></code></pre></div>
<h3 id="復旧手順">6.2 復旧手順</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># データベースの復旧</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py loaddata backup.json</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 特定アプリの復旧</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> manage.py loaddata food_backup.json</span></code></pre></div>
<h2 id="パフォーマンス最適化">7. パフォーマンス最適化</h2>
<h3 id="クエリ最適化">7.1 クエリ最適化</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 効率的なクエリ例</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_active_orders():</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FoodOrder.objects.<span class="bu">filter</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        is_completed<span class="op">=</span><span class="va">False</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    ).select_related().order_by(<span class="st">&#39;timestamp&#39;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_orders_by_clip(color, number):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FoodOrder.objects.<span class="bu">filter</span>(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        clip_color<span class="op">=</span>color,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        clip_number<span class="op">=</span>number,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        is_completed<span class="op">=</span><span class="va">False</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    ).first()</span></code></pre></div>
<h3 id="インデックス戦略">7.2 インデックス戦略</h3>
<ul>
<li><strong>検索頻度の高いフィールド</strong>:
プライマリキー、グループID、状態</li>
<li><strong>結合に使用されるフィールド</strong>:
クリップ情報、完了フラグ</li>
<li><strong>ソートに使用されるフィールド</strong>: タイムスタンプ</li>
</ul>
<h2 id="監視ログ">8. 監視・ログ</h2>
<h3 id="データベース監視">8.1 データベース監視</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 注文数の監視</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_order_statistics():</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    total_orders <span class="op">=</span> FoodOrder.objects.count()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    completed_orders <span class="op">=</span> FoodOrder.objects.<span class="bu">filter</span>(is_completed<span class="op">=</span><span class="va">True</span>).count()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    pending_orders <span class="op">=</span> total_orders <span class="op">-</span> completed_orders</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;total&#39;</span>: total_orders,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;completed&#39;</span>: completed_orders,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;pending&#39;</span>: pending_orders</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<h3 id="ログ設定">8.2 ログ設定</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># settings.py</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>LOGGING <span class="op">=</span> {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;version&#39;</span>: <span class="dv">1</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;disable_existing_loggers&#39;</span>: <span class="va">False</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;handlers&#39;</span>: {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;file&#39;</span>: {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;level&#39;</span>: <span class="st">&#39;INFO&#39;</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;class&#39;</span>: <span class="st">&#39;logging.FileHandler&#39;</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;filename&#39;</span>: <span class="st">&#39;debug.log&#39;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;loggers&#39;</span>: {</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;django.db.backends&#39;</span>: {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;handlers&#39;</span>: [<span class="st">&#39;file&#39;</span>],</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;level&#39;</span>: <span class="st">&#39;INFO&#39;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
<p><strong>作成日</strong>: 2025年8月 <strong>作成者</strong>: 村岡
優次郎 <strong>バージョン</strong>: 1.0</p>
